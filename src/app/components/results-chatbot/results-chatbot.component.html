<div class="chatbot-wrapper">
  <!-- Bot√≥n flotante cuando el chat est√° cerrado -->
  <button
    *ngIf="!isOpen"
    class="chatbot-toggle-button"
    type="button"
    (click)="toggleOpen()"
  >
    üí¨
  </button>

  <!-- Ventana del chat -->
  <div *ngIf="isOpen" class="chatbot-container">
    <div class="chatbot-header">
      <div>
        <h4>Asistente de Resultados</h4>
        <small>Ayuda para entender tus an√°lisis</small>
      </div>
      <button
        class="chatbot-close"
        type="button"
        (click)="toggleOpen(); $event.stopPropagation()"
      >
        ‚úï
      </button>
    </div>

    <div class="chatbot-body">
      <div class="warning">
        ‚ö†Ô∏è Este asistente es solo de apoyo y no reemplaza la opini√≥n de un
        m√©dico.
      </div>

      <div class="messages" #messagesContainer>
        <div
          *ngFor="let msg of messages"
          class="message"
          [ngClass]="{
            'from-user': msg.from === 'user',
            'from-bot': msg.from === 'bot'
          }"
        >
          <div class="message-text">
            {{ msg.text }}
          </div>
          <div class="message-meta">
            {{ msg.timestamp | date : "shortTime" }}
          </div>
        </div>

        <div *ngIf="loading" class="message from-bot typing">
          <div class="message-text">Analizando tus resultados...</div>
        </div>
      </div>

      <div *ngIf="error" class="error">
        {{ error }}
      </div>
    </div>

    <div class="chatbot-input">
      <textarea
        [(ngModel)]="currentQuestion"
        (keydown)="onEnter($event)"
        placeholder="Ej: ¬øMi nivel de colesterol est√° dentro del rango normal?"
        [disabled]="!appointmentId || loading"
      >
      </textarea>
      <button
        type="button"
        (click)="sendMessage()"
        [disabled]="!appointmentId || loading || !currentQuestion.trim()"
      >
        Enviar
      </button>
    </div>
  </div>
</div>
